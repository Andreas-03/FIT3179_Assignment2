{
    "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
    "config": {"font": "Helvetica","legend": {"titleFontSize": 14, "labelFontSize": 12}, "axis": {"labelFontSize": 12, "titleFontSize": 14}},
    "data": {"url": "Prevalence_of_drug_use_and_regional_estimates.csv"},
    "width": "container",
    "height": 550,
    "params":[
            {
            "name": "region_selection",
            "bind": {
                "input": "select",
                "options": [
                    null,
                    "Africa",
                    "Asia",
                    "Europe",
                    "Americas",
                    "Oceania"
                ],
                "labels":[
                    "Show All",
                    "Africa",
                    "Asia",
                    "Europe",
                    "Americas",
                    "Oceania"
                ],
                "name": "Region: "
            }
            }
        ],
    "layer":[
        {
        "transform": [
            {
            "filter": "datum.Region == region_selection"
            },
            {
            },
            {
            "calculate": "datum.Prevalence / 100" , "as": "Prevalence%"
            }
        ],
        "params": [
            {
            "name": "drug_hightlight",
            "select": {"type": "point", "fields": ["Drug_type"]},
            "bind": "legend"
            }
        ],
        "mark": 
            {
            "type": "arc",
            "innerRadius": 20,
            "stroke": "white"
            },
        "encoding": 
            {
            "theta": {"field": "Prevalence", "type": "quantitative", "stack": true, "title": "Prevalence"},
            "radius": {"field": "Prevalence", "scale": {"type": "sqrt", "zero": true, "rangeMin": 100}, "title": "Prevalence"},
            "color": {
                "field": "Drug_type", 
                "type": "nominal", 
                "title": "Drug Type",
                "scale": {"scheme": "category20"}
                    },
            "opacity": {
                "condition": {"param": "drug_hightlight", "value": 1},
                "value": 0.2
                },
            "tooltip": [
                {"field": "Region", "type": "nominal", "title": "Region"},
                {"field": "Drug_type", "type": "nominal", "title": "Drug Type"},
                {"field": "Prevalence%", "type": "quantitative", "title": "Prevalence", "format": ".2%"},
                {"field": "Number", "type": "quantitative", "title": "Estimated Number", "format": ",d"}
                ]
            }
        },
        {
            "transform": [
                {"filter": "region_selection == null"},
                {"calculate": "datum.Number / (datum.Prevalence / 100)", "as": "Population"},
                {"aggregate": [{"op": "sum", "field": "Population", "as": "TotalPopulation"},
                               {"op": "sum", "field": "Number", "as": "TotalNumber"}], 
                 "groupby": ["Drug_type"]},
                {"calculate": "datum.TotalNumber / datum.TotalPopulation ", "as": "TotalPrevalence%"},
                {"calculate": "'All'", "as": "Region_tooltip"}
            ],
            "mark": {
                "type": "arc",
                "innerRadius": 20,
                "stroke": "white"
            },
            "encoding": {
                "theta": {"field": "TotalPrevalence%", "type": "quantitative", "stack": true, "title": "Total Prevalence"},
                "radius": {"field": "TotalPrevalence%", "scale": {"type": "sqrt", "zero": true, "rangeMin": 100}, "title": "Total Prevalence"},
                "color": {
                    "field": "Drug_type",
                    "type": "nominal",
                    "title": "Drug Type",
                    "scale": {"scheme": "category20"}
                },
                "tooltip": [
                    {"field": "Region_tooltip", "type": "nominal", "title": "Region"},
                    {"field": "Drug_type", "type": "nominal", "title": "Drug Type"},
                    {"field": "TotalPrevalence%", "type": "quantitative", "title": "Prevalence", "format": ".2%"},
                    {"field": "TotalNumber", "type": "quantitative", "title": "Estimated Number", "format": ",d"}
                ]
            }
        },
        {
            "transform": [
                {"filter": "datum.Drug_type=='Cannabis' && (datum.Region == region_selection || region_selection == null)"},
                {"aggregate": [{"op": "count", "as": "count"}], "groupby": ["Drug_type"]}
            ],
            "mark": {
                "type": "text",
                "align": "center",
                "baseline": "middle",
                "fontSize": 12,
                "dy": 100,
                "dx": 100,
                "fontWeight": "normal",
                "lineBreak": "\n"
            },
            "encoding": {
                "text": {"datum": "Cannabis has the highest prevalence\n among all drugs due to it being\n legalised in many countries"}
            }
        }
    ],
    
    "view": {"stroke": null}
  }
  